#!/bin/bash
set -e

export_env_dir() {
  env_dir=$3
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" && export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

BUILD_DIR=$1
CACHE_DIR=$2

CMAKE_PATH="https://cmake.org/files/v3.2/cmake-3.2.3-Linux-x86_64.tar.gz"
CMAKE_FILE="${CMAKE_PATH##*/}"
CMAKE_DIR="${CMAKE_FILE%.*.*}"

mkdir -p $CACHE_DIR
pushd $CACHE_DIR
  if [ ! -f $CACHE_DIR/$CMAKE_FILE ]; then
    echo "-----> Downloading CMake"
    curl -sO $CMAKE_PATH
    tar -xzf $CMAKE_FILE
  fi
popd

mkdir -p $BUILD_DIR/build
pushd $BUILD_DIR/build
  echo "-----> Running CMake"
  $CACHE_DIR/$CMAKE_DIR/bin/cmake $BUILD_DIR
  echo "-----> Running Make"
  export_env_dir()
  make
popd
